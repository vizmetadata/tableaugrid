<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Data Grid Extension</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            padding: 15px; 
            text-align: center; 
        }
        .header h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.9; }
        .status { 
            padding: 12px 15px; 
            background: #fff3cd; 
            border-left: 4px solid #ffc107; 
            color: #856404; 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        .status.success { border-color: #28a745; background: #d4edda; color: #155724; }
        .status.error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
        .debug-section { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin: 10px; 
        }
        .debug-box { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            font-size: 10px; 
            max-height: 120px; 
            overflow-y: auto;
        }
        .debug-box.env { background: #e3f2fd; border-color: #2196f3; }
        .debug-box h4 { font-family: inherit; margin-bottom: 8px; font-size: 11px; }
        .worksheet-selector { 
            padding: 10px 15px; 
            background: #fff; 
            border-bottom: 1px solid #dee2e6; 
            display: none;
        }
        .worksheet-selector select { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 13px; 
        }
        .grid-container { padding: 15px; overflow-x: auto; max-height: 60vh; }
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            border-radius: 6px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            font-size: 12px;
        }
        .data-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .data-table th { padding: 10px 8px; text-align: left; font-weight: 600; font-size: 11px; }
        .data-table td { padding: 8px; border-bottom: 1px solid #e9ecef; }
        .data-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table tbody tr:hover { background-color: #e3f2fd; cursor: pointer; }
        .stats { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 15px; 
            background: #f8f9fa; 
            border-top: 1px solid #dee2e6; 
            font-size: 11px; 
            color: #6c757d; 
        }
        .btn-group { 
            text-align: center; 
            padding: 10px; 
            background: #f8f9fa; 
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 0 5px; 
            font-size: 11px; 
        }
        .btn:hover { background: #0056b3; }
        .btn.secondary { background: #6c757d; }
        .loading { display: inline-block; width: 12px; height: 12px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 6px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tableau Data Grid</h1>
            <p>Enterprise-grade data visualization extension</p>
        </div>
        
        <div id="status" class="status">
            <span class="loading"></span>
            Initializing connection to Tableau Extensions API...
        </div>
        
        <div class="debug-section">
            <div class="debug-box">
                <h4>üîç Connection Log</h4>
                <div id="debug-log">Starting extension...</div>
            </div>
            <div class="debug-box env">
                <h4>üåê Environment Status</h4>
                <div id="env-status">Checking environment...</div>
            </div>
        </div>
        
        <div id="worksheet-selector" class="worksheet-selector">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px;">
                Select Data Source:
            </label>
            <select id="worksheetSelect">
                <option value="">Choose a worksheet...</option>
            </select>
        </div>
        
        <div class="grid-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="status-table">
                    <tr>
                        <td>üöÄ Extension Engine</td>
                        <td><span style="color: #28a745;">‚úì Running</span></td>
                        <td>Core extension loaded successfully</td>
                    </tr>
                    <tr>
                        <td>üîó GitHub Hosting</td>
                        <td><span style="color: #28a745;">‚úì Active</span></td>
                        <td>Serving from vizmetadata.github.io</td>
                    </tr>
                    <tr>
                        <td>üì° Tableau API</td>
                        <td><span style="color: #ffc107;">‚è≥ Connecting</span></td>
                        <td>Attempting to establish connection...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="stats">
            <span id="connection-time">Connection time: --</span>
            <span id="api-version">API Version: --</span>
            <span id="worksheet-count">Worksheets: --</span>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="retryConnection()">üîÑ Retry Connection</button>
            <button class="btn secondary" onclick="runDiagnostics()">üî¨ Run Diagnostics</button>
        </div>
    </div>

    <script>
        class TableauExtensionEngine {
            constructor() {
                this.startTime = Date.now();
                this.debugLog = [];
                this.apiStatus = 'initializing';
                this.worksheets = [];
                this.init();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `${timestamp}: ${message}`;
                this.debugLog.push(logEntry);
                
                const debugEl = document.getElementById('debug-log');
                if (debugEl) {
                    debugEl.innerHTML = this.debugLog.slice(-8).join('<br>');
                    debugEl.scrollTop = debugEl.scrollHeight;
                }
                console.log(`[Tableau Extension] ${logEntry}`);
            }

            updateStatus(message, type = 'loading') {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${type}`;
                
                let icon = '';
                switch(type) {
                    case 'loading': icon = '<span class="loading"></span>'; break;
                    case 'success': icon = '‚úÖ '; break;
                    case 'error': icon = '‚ùå '; break;
                    default: icon = 'üì° '; break;
                }
                
                statusEl.innerHTML = icon + message;
            }

            updateEnvironmentStatus() {
                const envEl = document.getElementById('env-status');
                const hasTableau = typeof tableau !== 'undefined';
                const hasExtensions = hasTableau && tableau.extensions;
                const inIframe = window.self !== window.top;
                const protocol = window.location.protocol;
                
                const envInfo = [
                    `tableau: ${hasTableau ? '‚úÖ Found' : '‚ùå Missing'}`,
                    `extensions: ${hasExtensions ? '‚úÖ Ready' : '‚ùå Not available'}`,
                    `iframe: ${inIframe ? '‚úÖ Yes' : '‚ùå No'}`,
                    `protocol: ${protocol}`,
                    `url: ${window.location.href.substring(0, 30)}...`
                ];
                
                envEl.innerHTML = envInfo.join('<br>');
                return hasExtensions;
            }

            updateConnectionTable(tableauStatus) {
                const tbody = document.getElementById('status-table');
                const apiRow = tbody.children[2];
                const statusCell = apiRow.children[1];
                const detailCell = apiRow.children[2];
                
                if (tableauStatus === 'connected') {
                    statusCell.innerHTML = '<span style="color: #28a745;">‚úì Connected</span>';
                    detailCell.textContent = `Connected to Tableau Extensions API v${tableau.extensions.apiVersion || '1.0'}`;
                } else if (tableauStatus === 'disabled') {
                    statusCell.innerHTML = '<span style="color: #dc3545;">‚úó Disabled</span>';
                    detailCell.textContent = 'Dashboard Extensions not enabled in Tableau settings';
                } else {
                    statusCell.innerHTML = '<span style="color: #ffc107;">‚è≥ Waiting</span>';
                    detailCell.textContent = 'Waiting for Tableau Extensions API injection...';
                }
            }

            async init() {
                this.log('üöÄ Initializing Tableau Extension Engine');
                this.updateEnvironmentStatus();
                
                // Immediate check
                if (this.updateEnvironmentStatus()) {
                    this.log('‚úÖ Tableau API available immediately');
                    await this.connectToTableau();
                    return;
                }
                
                // Progressive connection attempts
                this.log('‚è≥ Waiting for Tableau API injection...');
                let attempts = 0;
                const maxAttempts = 60;
                
                const connectionInterval = setInterval(async () => {
                    attempts++;
                    
                    if (this.updateEnvironmentStatus()) {
                        clearInterval(connectionInterval);
                        this.log(`‚úÖ Tableau API detected after ${attempts} attempts`);
                        await this.connectToTableau();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(connectionInterval);
                        this.log('‚ùå Tableau API not available after 30 seconds');
                        this.handleConnectionFailure();
                    } else if (attempts % 10 === 0) {
                        this.log(`‚è≥ Still waiting... attempt ${attempts}/${maxAttempts}`);
                    }
                }, 500);
            }

            async connectToTableau() {
                try {
                    this.updateStatus('Establishing secure connection to Tableau...', 'loading');
                    this.updateConnectionTable('connecting');
                    
                    await tableau.extensions.initializeAsync();
                    
                    const connectionTime = ((Date.now() - this.startTime) / 1000).toFixed(1);
                    this.log(`‚úÖ Connected to Tableau Extensions API in ${connectionTime}s`);
                    
                    await this.loadWorksheetData();
                    
                    this.updateStatus('üéâ Successfully connected to Tableau!', 'success');
                    this.updateConnectionTable('connected');
                    
                    // Update stats
                    document.getElementById('connection-time').textContent = `Connected in ${connectionTime}s`;
                    document.getElementById('api-version').textContent = `API v${tableau.extensions.apiVersion || '1.0'}`;
                    
                } catch (error) {
                    this.log(`‚ùå Connection failed: ${error.message}`);
                    this.updateStatus(`Connection failed: ${error.message}`, 'error');
                    this.updateConnectionTable('disabled');
                }
            }

            async loadWorksheetData() {
                const dashboard = tableau.extensions.dashboardContent.dashboard;
                this.worksheets = dashboard.worksheets;
                
                this.log(`üìä Found ${this.worksheets.length} worksheets in dashboard`);
                document.getElementById('worksheet-count').textContent = `${this.worksheets.length} worksheets`;
                
                if (this.worksheets.length === 0) {
                    this.log('‚ö†Ô∏è No worksheets found - dashboard may be empty');
                    return;
                }
                
                // Populate selector
                const select = document.getElementById('worksheetSelect');
                select.innerHTML = '<option value="">Choose a worksheet...</option>';
                
                this.worksheets.forEach((worksheet, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = worksheet.name;
                    select.appendChild(option);
                    this.log(`üìã Added worksheet: ${worksheet.name}`);
                });
                
                document.getElementById('worksheet-selector').style.display = 'block';
                
                // Auto-select first worksheet
                if (this.worksheets.length > 0) {
                    select.value = '0';
                    await this.selectWorksheet(0);
                }
                
                select.addEventListener('change', async (e) => {
                    if (e.target.value !== '') {
                        await this.selectWorksheet(parseInt(e.target.value));
                    }
                });
            }

            async selectWorksheet(index) {
                try {
                    const worksheet = this.worksheets[index];
                    this.log(`üì• Loading data from "${worksheet.name}"`);
                    this.updateStatus(`Loading data from "${worksheet.name}"...`, 'loading');
                    
                    const dataTable = await worksheet.getSummaryDataAsync({
                        maxRows: 1000,
                        includeDataValues: true
                    });
                    
                    this.renderWorksheetData(dataTable, worksheet.name);
                    this.log(`‚úÖ Loaded ${dataTable.totalRowCount} rows from "${worksheet.name}"`);
                    this.updateStatus(`Displaying ${dataTable.totalRowCount} rows from "${worksheet.name}"`, 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Error loading worksheet: ${error.message}`);
                    this.updateStatus(`Error loading data: ${error.message}`, 'error');
                }
            }

            renderWorksheetData(dataTable, worksheetName) {
                const container = document.querySelector('.grid-container');
                
                if (dataTable.totalRowCount === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>No Data Available</h3><p>Selected worksheet contains no data</p></div>';
                    return;
                }
                
                let html = '<table class="data-table"><thead><tr>';
                
                dataTable.columns.forEach(col => {
                    html += `<th title="Type: ${col.dataType}">${col.fieldName}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                dataTable.data.forEach((row, rowIndex) => {
                    html += `<tr data-row="${rowIndex}">`;
                    row.forEach(cell => {
                        const cellValue = cell.formattedValue || cell.value || '';
                        html += `<td title="${cellValue}">${cellValue}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Update stats
                document.querySelector('.stats').innerHTML = `
                    <span>${dataTable.totalRowCount.toLocaleString()} rows</span>
                    <span>${dataTable.columns.length} columns</span>
                    <span>From "${worksheetName}"</span>
                `;
            }

            handleConnectionFailure() {
                this.updateStatus('Dashboard Extensions may be disabled in Tableau', 'error');
                this.updateConnectionTable('disabled');
                
                // Show instructions
                const container = document.querySelector('.grid-container');
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <h3 style="color: #dc3545; margin-bottom: 15px;">üîß Enable Tableau Extensions</h3>
                        <div style="text-align: left; max-width: 500px; margin: 0 auto; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h4>For Tableau Desktop:</h4>
                            <ol style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                                <li>Help ‚Üí Settings and Performance ‚Üí Manage External Service Connection</li>
                                <li>Enable "Dashboard Extensions"</li>
                                <li>Restart Tableau Desktop</li>
                                <li>Refresh this dashboard</li>
                            </ol>
                            <h4 style="margin-top: 15px;">For Tableau Cloud:</h4>
                            <ol style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                                <li>Site Settings ‚Üí Extensions</li>
                                <li>Enable "Dashboard Extensions"</li>
                                <li>Contact your site administrator if needed</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
        }

        // Global functions for UI buttons
        function retryConnection() {
            window.extensionEngine = new TableauExtensionEngine();
        }

        function runDiagnostics() {
            window.extensionEngine.log('üî¨ Running diagnostics...');
            window.extensionEngine.updateEnvironmentStatus();
            
            const diagnostics = {
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: new Date().toISOString(),
                location: window.location.href,
                tableauAvailable: typeof tableau !== 'undefined',
                extensionsAvailable: typeof tableau !== 'undefined' && tableau.extensions,
                inIframe: window.self !== window.top
            };
            
            console.log('üî¨ Diagnostics Report:', diagnostics);
            window.extensionEngine.log('üî¨ Diagnostics completed - check browser console');
        }

        // Initialize extension engine
        document.addEventListener('DOMContentLoaded', function() {
            window.extensionEngine = new TableauExtensionEngine();
        });
    </script>
</body>
</html>
